---
- hosts: ffw-test ffw-dev-vb
  user: root
  vars: 
    adminuser: 'ffw_admin'
    adminpassword: 'gyACXJaQZC2L'
  tasks:
  # Setup to users on the ffw-test server
  - name: Setup | create user ffw_admin and ffw_cms
    command: useradd -m {{ item }} creates=/home/{{ item }}
    become: true
    become_method: sudo
    with_items:
      - ffw_admin
      - ffw_cms
 
  # Setup passwords for both user 'ffw_admin' and 'ffw_user' on our ffw-test server
  - name: Setup | set passwords for ffw_admin and ffw_user
    shell: usermod -p $(echo '{{ item.createpassword }}' | openssl passwd -1 -stdin) {{ item.createuser }}
    become: true
    become_method: sudo
    with_items:
      - { createpassword: 'gyACXJaQZC2L', createuser: 'ffw_admin' }
      - { createpassword: 'MyVroGJPMdP2', createuser: 'ffw_cms' }
    
  # Setup an public key for this remote machine by copying the public key of this machine to the remote machine.
  # We need to have our id_rsa.pub file within the directory of this setup.yml file.
  - name: Setup | authorized key upload
    authorized_key: user={{ item }}
      key="{{ lookup('file', 'id_rsa.pub') }}"
      path='/home/{{ item }}/.ssh/authorized_keys'
      manage_dir=no
    become: true
    with_items:
      - ffw_admin
      - ffw_cms

  # Add our admin user to the 'sudo' users file.
  - name: Sudoers | update sudoers file and validate
    lineinfile: "dest=/etc/sudoers
      insertafter=EOF
      line='{{ adminuser }} ALL=(ALL) NOPASSWD: ALL'
      regexp='{{ adminuser }} ALL=(ALL) NOPASSWD: ALL'
      state=present"
    become: true

